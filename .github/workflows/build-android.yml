name: Build Android

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allows manual trigger

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        target: default
        arch: arm64-v8a

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android

    - name: Install dependencies
      run: yarn install

    - name: Debug environment
      run: |
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "JAVA_HOME: $JAVA_HOME"
        echo "NDK_HOME: $ANDROID_NDK_HOME"
        ls -la $ANDROID_HOME || echo "ANDROID_HOME not found"
        which java || echo "Java not found"

    - name: Initialize Android project
      run: |
        echo "Running tauri android init..."
        yarn tauri android init 2>&1 || {
          echo "tauri android init failed, checking if directory exists anyway..."
        }
        echo "Checking src-tauri directory..."
        ls -la src-tauri/
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}
        JAVA_HOME: ${{ env.JAVA_HOME }}

    - name: Verify Android project exists
      run: |
        # Tauri v2 creates Android project in src-tauri/gen/android/
        if [ -d "src-tauri/gen/android" ]; then
          echo "Android project directory found at: src-tauri/gen/android"
          ls -la src-tauri/gen/android/
        elif [ -d "src-tauri/android" ]; then
          echo "Android project directory found at: src-tauri/android"
          ls -la src-tauri/android/
        else
          echo "Error: Android project directory not found"
          echo "Contents of src-tauri:"
          ls -la src-tauri/
          echo "Contents of src-tauri/gen (if exists):"
          ls -la src-tauri/gen/ || echo "gen directory not found"
          exit 1
        fi

    - name: Setup NDK environment
      run: |
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV

        # Find the NDK toolchain directory - try multiple common paths
        NDK_TOOLCHAIN=""
        if [ -d "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" ]; then
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
        elif [ -d "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86/bin" ]; then
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86/bin"
        else
          FOUND_PATH=$(find "$ANDROID_NDK_HOME" -type d -path "*/toolchains/llvm/prebuilt/*/bin" 2>/dev/null | head -1)
          if [ -n "$FOUND_PATH" ]; then
            NDK_TOOLCHAIN="$FOUND_PATH"
          else
            echo "Error: Could not find NDK toolchain directory"
            exit 1
          fi
        fi

        echo "NDK_TOOLCHAIN=$NDK_TOOLCHAIN" >> $GITHUB_ENV
        echo "PATH=$NDK_TOOLCHAIN:$PATH" >> $GITHUB_ENV

        CLANG=""
        CLANGXX=""
        AR=""
        if [ -f "$NDK_TOOLCHAIN/aarch64-linux-android33-clang" ]; then
          CLANG="$NDK_TOOLCHAIN/aarch64-linux-android33-clang"
          CLANGXX="$NDK_TOOLCHAIN/aarch64-linux-android33-clang++"
        elif [ -f "$NDK_TOOLCHAIN/aarch64-linux-android34-clang" ]; then
          CLANG="$NDK_TOOLCHAIN/aarch64-linux-android34-clang"
          CLANGXX="$NDK_TOOLCHAIN/aarch64-linux-android34-clang++"
        else
          FOUND_CLANG=$(find "$NDK_TOOLCHAIN" -name "aarch64-linux-android*-clang" 2>/dev/null | head -1)
          if [ -n "$FOUND_CLANG" ]; then
            CLANG="$FOUND_CLANG"
            CLANGXX="${FOUND_CLANG}++"
          fi
        fi
        if [ -f "$NDK_TOOLCHAIN/llvm-ar" ]; then
          AR="$NDK_TOOLCHAIN/llvm-ar"
        else
          FOUND_AR=$(find "$NDK_TOOLCHAIN" -name "llvm-ar" 2>/dev/null | head -1)
          [ -n "$FOUND_AR" ] && AR="$FOUND_AR"
        fi
        if [ -z "$CLANG" ] || [ -z "$AR" ]; then
          echo "Error: Could not find required NDK tools"
          ls -la "$NDK_TOOLCHAIN" || true
          exit 1
        fi
        echo "CC_aarch64_linux_android=$CLANG" >> $GITHUB_ENV
        echo "CXX_aarch64_linux_android=$CLANGXX" >> $GITHUB_ENV
        echo "AR_aarch64_linux_android=$AR" >> $GITHUB_ENV
        echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$CLANG" >> $GITHUB_ENV
        echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_AR=$AR" >> $GITHUB_ENV

    - name: Build Android APK
      run: yarn tauri android build
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}
        ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        ANDROID_NDK_ROOT: ${{ env.ANDROID_NDK_HOME }}
        JAVA_HOME: ${{ env.JAVA_HOME }}
        CC_aarch64_linux_android: ${{ env.CC_aarch64_linux_android }}
        CXX_aarch64_linux_android: ${{ env.CXX_aarch64_linux_android }}
        AR_aarch64_linux_android: ${{ env.AR_aarch64_linux_android }}
        CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: ${{ env.CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER }}
        CARGO_TARGET_AARCH64_LINUX_ANDROID_AR: ${{ env.CARGO_TARGET_AARCH64_LINUX_ANDROID_AR }}

    - name: Find APK files
      run: |
        echo "Searching for APK files..."
        find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"

    - name: Upload APK (Release)
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-release
        path: |
          src-tauri/gen/android/app/build/outputs/apk/**/*.apk
          src-tauri/android/app/build/outputs/apk/**/*.apk
        if-no-files-found: warn
        retention-days: 30

    - name: Upload AAB (if exists)
      uses: actions/upload-artifact@v4
      continue-on-error: true
      if: always()
      with:
        name: android-aab-release
        path: |
          src-tauri/gen/android/app/build/outputs/bundle/**/*.aab
          src-tauri/android/app/build/outputs/bundle/**/*.aab
        if-no-files-found: ignore
        retention-days: 30
